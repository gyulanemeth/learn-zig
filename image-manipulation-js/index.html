<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JS Image Manipulation Reference Implementation</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.3.17/dist/vuetify.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vuetify@3.3.17/dist/vuetify.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css">
  </head>
  <body>
    <div id="app">
      <v-layout class="rounded rounded-md">
        <v-navigation-drawer permanent>
          <v-list>
            <v-list-item title="Yo"></v-list-item>
          </v-list>
          <template v-slot:append>
            <v-card v-if="imgData">
              <v-card-subtitle>Selection</v-card-subtitle>
              <v-card-text>
                <canvas v-draw-image="selectionImgData" style="border: 1px dotted gray; width: 100%"></canvas>
              </v-card-text>
            </v-card>
          </template>
        </v-navigation-drawer>
    
        <v-main class="d-flex align-center justify-center" style="min-height: 300px;">
          <v-container>
            <v-row>
              <v-col>
                <v-toolbar
                flat
                density="compact"
                :elevation="1"
                >
                  <v-menu>
                    <template v-slot:activator="{ props }">
                      <v-btn icon v-bind="props">
                        <v-icon v-if="selection.actSelectionTool.value === 'rectangle'">mdi-select-drag</v-icon>
                        <v-icon v-if="selection.actSelectionTool.value === 'hsl'">mdi-select-color</v-icon>
                      </v-btn>
                    </template>
                    <v-card min-width="300">
                      <v-card-subtitle>Selection tool</v-card-subtitle>
                      <v-toolbar flat density="compact">
                        <v-btn-toggle v-model="selection.actSelectionTool.value" mandatory>
                          <v-btn icon value="rectangle">
                            <v-icon>mdi-select-drag</v-icon>
                          </v-btn>
                          <v-btn icon value="hsl">
                            <v-icon>mdi-select-color</v-icon>
                          </v-btn>
                        </v-btn-toggle>
                      </v-toolbar>
                      <v-card-subtitle>Selection actions</v-card-subtitle>
                      <v-toolbar flat density="compact">
                        <v-btn icon>
                          <v-icon @click="selection.selectAll">mdi-select-all</v-icon>
                        </v-btn>
                        <v-btn icon>
                          <v-icon @click="selection.invert">mdi-select-inverse</v-icon>
                        </v-btn>
                        <v-btn icon>
                          <v-icon @click="selection.deselectAll">mdi-select</v-icon>
                        </v-btn>
                      </v-toolbar>
                    </v-card>
                  </v-menu>
                  <v-btn icon>
                    <v-icon>mdi-brush</v-icon>
                  </v-btn>
                  <v-btn icon>
                    <v-icon>mdi-palette</v-icon>
                  </v-btn>
                  <v-btn icon @click="invert">
                    <v-icon>mdi-test-tube</v-icon>
                  </v-btn>
                  <v-spacer></v-spacer>
                  <v-select
                    style="max-width: 130px;"
                    v-model="toolbar.zoom.value"
                    :items="toolbar.zoomValues"
                    hide-details
                    flat
                    prepend-inner-icon="mdi-magnify-plus-outline"
                  ></v-select>
                </v-toolbar>
              </v-col>
            </v-row>
            <v-row>
              <v-col class="d-flex justify-center align-center">
                <canvas v-draw-image="imgData" @click="canvasClick" :style="{ transform: `scale(${parseInt(toolbar.zoom.value.replace('%', '')) / 100})` }"></canvas>
              </v-col>
            </v-row>
          </v-container>
        </v-main>
      </v-layout>
    </div>
    <script>
      const { createApp, ref } = Vue
      const { createVuetify } = Vuetify

      let imgHandler = null
      let selectionHandler = null
      let rgbManipulation = null

      const vuetify = createVuetify()

      const imgData = ref(null)
      const selectionImgData = ref(null)

      function updateSelectionImgData(selection) {
        for (let idx = 0; idx < selection.length; idx += 1) {
          const imgIdx = idx * 4
          if (selection[idx] === 0) {
            selectionImgData.value.data[imgIdx] = 0
            selectionImgData.value.data[imgIdx + 1] = 0
            selectionImgData.value.data[imgIdx + 2] = 0
            selectionImgData.value.data[imgIdx + 3] = 0
          } else {
            selectionImgData.value.data[imgIdx] = imgData.value.data[imgIdx]
            selectionImgData.value.data[imgIdx + 1] = imgData.value.data[imgIdx + 1]
            selectionImgData.value.data[imgIdx + 2] = imgData.value.data[imgIdx + 2]
            selectionImgData.value.data[imgIdx + 3] = imgData.value.data[imgIdx + 3]
          }
        }
        const temp = selectionImgData.value
        selectionImgData.value = null
        selectionImgData.value = temp
      }
      function selectAll() {
        selectionHandler.selectAll()
      }

      function invertSelection() {
        selectionHandler.invert()
      }

      function deselectAll() {
        selectionHandler.deselectAll()
      }

      function invert() {
        rgbManipulation.invert(imgData.value, selectionHandler.selection)
        const temp = imgData.value
        imgData.value = null
        imgData.value = temp
      }

      createApp({
        setup() {        
          const imgSrc = ref('./lena.png')
          async function init() {
            imgHandler = await import('./image-handling.js')
            const createSelectionHandler = await import('./selection.js')
            rgbManipulation = await import('./rgb-manipulation.js')

            const img = await imgHandler.loadImg(imgSrc.value)
            const loaderCanvas = document.createElement('canvas')
            loaderCanvas.width = img.width
            loaderCanvas.height = img.height
            const loaderCanvasContext = loaderCanvas.getContext('2d')
            loaderCanvasContext.drawImage(img, 0, 0)
            const loadedImgData = loaderCanvasContext.getImageData(0, 0, img.width, img.height)

            imgData.value = loadedImgData

            const selImg = new ImageData(img.width, img.height)
            selectionImgData.value = selImg
            selectionHandler = createSelectionHandler.default(loadedImgData, updateSelectionImgData)
          }

          init()

          const zoom = ref('100%')
          const actTool = ref('selection')
          const actSelectionTool = ref('rectangle')

          function canvasClick(event) {
            const canvas = event.target
            const bb = canvas.getBoundingClientRect()
            const x = Math.floor( (event.clientX - bb.left) / bb.width * canvas.width )
            const y = Math.floor( (event.clientY - bb.top) / bb.height * canvas.height )

            if (actSelectionTool.value === 'rectangle') {
              selectionHandler.rectangularSelection({ x, y }, { x: x + 100, y: y + 50 })
            } else {
              selectionHandler.addBasedOnHslRange({ x, y })
            }
          }

          return {
            toolbar: {
              zoom,
              zoomValues: ['100%', '75%', '50%', '25%']
            },

            imgSrc,
            imgData,
            selectionImgData,

            selection: {
              actSelectionTool,

              selectAll,
              invert: invertSelection,
              deselectAll
            },

            invert,

            canvasClick
          }
        },
        directives: {
          'draw-image': {
            created(el, binding, vnode, prevVnode) {
              const imgData = binding.value

              if (!imgData) {
                return
              }

              imgHandler.drawImageToCanvas(el, imgData)
            },
            updated(el, binding, vnode, prevVnode) {
              const imgData = binding.value

              if (!imgData) {
                return
              }

              imgHandler.drawImageToCanvas(el, imgData)
            }
          }
        }
      }).use(vuetify).mount('#app')
    </script>
  </body>
</html>
