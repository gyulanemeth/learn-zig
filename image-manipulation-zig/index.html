<html>
    <head>
        <title>zig image manipulation test</title>
        <style>
          body {
            margin: 0;
            padding: 0;
          }
          td {
            padding: 5px;
          }
        </style>
    </head>
    <body>
        <span>
            <table>
                <tr>
                    <td>Javascript</td>
                    <td><button id="invert-js">Invert</button></td>
                    <td><button id="grayscale-js">Grayscale</button></td>
                    <td><button id="blur-js">Blur</button></td>
                    <td><button id="sharpen-js">Sharpen</button></td>
                    <td><button id="edge-js">Edge detection</button></td>
                </tr>
                <tr>
                    <td>Zig WASM</td>
                    <td><button id="invert-zig">Invert</button></td>
                    <td><button id="grayscale-zig">Grayscale</button></td>
                    <td><button id="blur-zig">Blur</button></td>
                    <td><button id="sharpen-zig">Sharpen</button></td>
                    <td><button id="edge-zig">Edge detection</button></td>
                </tr>
            </table>
        </span>
        <span>
            <span>Last exec. time:</span>
            <span id="exec-time"></span>
        </span>
        <div>
            <canvas id="canvas"></canvas>
        </div>
        <div>
            
        </div>
        <script src="./image-manipulation.js"></script>
        <script src="./image-manipulation-wasm-wrapper.js"></script>
        <script>
            const canvas = document.getElementById('canvas')
            const context = canvas.getContext('2d', { willReadFrequently: true })

            function loadImg(url) {
              return new Promise(resolve => {
                let img = new Image()
                img.crossOrigin = 'Anonymous'
                img.onload = () => resolve(img)
                img.src = url
              })
            }

            async function loadImgToCanvas(url) {
              const img = await loadImg(url)
              canvas.width = img.naturalWidth
              canvas.height = img.naturalHeight
              context.drawImage(img, 0, 0)
            }

            async function main() {
                const start = performance.now()

                // await loadImgToCanvas('./lena.png')
                await loadImgToCanvas('./valencia.jpeg')
                const end = performance.now()
                console.log('image to canvas', start - end)



                const wasmAlgos = await createWasmWrapper(context, canvas.height, canvas.width)
                const jsAlgos = createImageManipulationFunctions(context, canvas.height, canvas.width)

                document.getElementById('invert-js').onclick = jsAlgos.invert
                document.getElementById('grayscale-js').onclick = jsAlgos.toGrayscale
                document.getElementById('blur-js').onclick = jsAlgos.blur
                document.getElementById('sharpen-js').onclick = jsAlgos.sharpen
                document.getElementById('edge-js').onclick = jsAlgos.edgeDetection

                document.getElementById('invert-zig').onclick = wasmAlgos.invert
                document.getElementById('grayscale-zig').onclick = wasmAlgos.toGrayscale
                document.getElementById('blur-zig').onclick = wasmAlgos.blur
                document.getElementById('sharpen-zig').onclick = wasmAlgos.sharpen
                document.getElementById('edge-zig').onclick = wasmAlgos.edgeDetection
            }
            main()
        </script>
    </body>
</html>